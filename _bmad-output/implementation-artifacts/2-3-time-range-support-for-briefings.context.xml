<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>2-3</story-id>
    <story-title>Time Range Support for Briefings</story-title>
    <epic>Epic 2: Economic Context and Time Ranges</epic>
    <generated>2026-01-09</generated>
    <status>IMPLEMENTED</status>
  </metadata>

  <summary>
    As a news follower, I want to specify time ranges for my briefings so that I can
    focus on recent events or investigate specific periods. This story adds an optional
    time_range parameter to the briefing() tool that accepts natural language time
    expressions (e.g., "last 24 hours", "last 7 days") and ISO date ranges
    (e.g., "2026-01-01 to 2026-01-08").
  </summary>

  <acceptance-criteria>
    <criterion id="AC1" status="COMPLETE">
      <title>Optional time_range Parameter Added to briefing() Tool</title>
      <description>
        The briefing() tool signature becomes briefing(topic: str, time_range: str | None = None).
        Docstring documents supported formats. MCP tool discovery shows the new parameter.
      </description>
      <evidence>
        <file path="src/ignifer/server.py" lines="189-216">
          briefing(topic: str, time_range: str | None = None) with full docstring
          documenting "last 24 hours", "last 7 days", "this week", "last week",
          and ISO date range formats.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC2" status="COMPLETE">
      <title>Natural Language Time Range Parsing</title>
      <description>
        Parses natural language like "last 24 hours", "last 48 hours", "this week",
        "last week", "last 7 days", "last 30 days". Case-insensitive parsing.
      </description>
      <evidence>
        <file path="src/ignifer/timeparse.py" lines="37-97">
          parse_time_range() function handles:
          - "last N hours/days/weeks/months" via LAST_N_PATTERN regex
          - "N hours/days/weeks/months" via N_UNIT_PATTERN regex
          - "this week" mapped to "7d"
          - "last week" mapped to absolute datetime range (7-14 days ago)
          All regex patterns use re.IGNORECASE for case-insensitive matching.
        </file>
        <file path="tests/test_timeparse.py" lines="116-128">
          test_parse_case_insensitive() verifies "LAST 24 HOURS", "Last 7 Days",
          "THIS WEEK" all parse correctly.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC3" status="COMPLETE">
      <title>ISO Date Range Support</title>
      <description>
        Supports "2026-01-01 to 2026-01-08" format using GDELT STARTDATETIME/ENDDATETIME
        parameters. Validates date formats before API call.
      </description>
      <evidence>
        <file path="src/ignifer/timeparse.py" lines="99-124">
          DATE_RANGE_PATTERN regex matches "YYYY-MM-DD to YYYY-MM-DD".
          Validates start &lt; end. Returns TimeRangeResult with start_datetime
          and end_datetime in YYYYMMDDHHMMSS format.
        </file>
        <file path="tests/test_timeparse.py" lines="82-103">
          test_parse_iso_date_range() verifies correct parsing.
          test_parse_iso_date_range_invalid_order() verifies start >= end error.
          test_parse_iso_date_range_invalid_format() verifies invalid date error.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC4" status="COMPLETE">
      <title>GDELT Query Time-Filtered</title>
      <description>
        GDELTAdapter.query() receives appropriate timespan parameter (e.g., timespan=48h).
        Results only include articles from that period. Output indicates time range covered.
      </description>
      <evidence>
        <file path="src/ignifer/adapters/gdelt.py" lines="108-131">
          Parses time_range if provided, adds timespan parameter for relative ranges
          or startdatetime/enddatetime for absolute ranges to query_params dict.
        </file>
        <file path="src/ignifer/output.py" lines="112-113">
          TIME RANGE line added to briefing header when time_range is provided.
        </file>
        <file path="tests/adapters/test_gdelt.py" lines="113-129">
          test_query_with_time_range_uses_timespan() verifies timespan=48h in URL.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC5" status="COMPLETE">
      <title>Default Time Range Behavior</title>
      <description>
        Without time_range parameter, defaults to 1 week timespan.
        Output indicates default time range used.
      </description>
      <evidence>
        <file path="src/ignifer/adapters/gdelt.py" lines="129-130">
          Default: query_params["timespan"] = "1week" when no time_range provided.
        </file>
        <file path="tests/adapters/test_gdelt.py" lines="154-170">
          test_query_default_time_range() verifies timespan=1week in URL.
        </file>
        <file path="tests/test_server.py" lines="153-188">
          test_briefing_default_time_range() verifies no TIME RANGE line when not specified.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC6" status="COMPLETE">
      <title>Invalid Time Range Error Handling</title>
      <description>
        Returns helpful error explaining supported formats. Suggests alternatives.
        Does NOT make API call with invalid parameters.
      </description>
      <evidence>
        <file path="src/ignifer/server.py" lines="220-235">
          Validates time_range before adapter call. Returns markdown error with
          "Invalid Time Range" header, supported formats list, and examples.
        </file>
        <file path="src/ignifer/timeparse.py" lines="127-129">
          Returns TimeRangeResult with error="Unrecognized time range format: {input}".
        </file>
        <file path="tests/test_server.py" lines="142-150">
          test_briefing_invalid_time_range_returns_error() verifies error message
          includes "Invalid Time Range", "Supported formats", and "Examples".
        </file>
      </evidence>
    </criterion>

    <criterion id="AC7" status="COMPLETE">
      <title>No Results for Time Range Handling</title>
      <description>
        When GDELT returns no results, suggests trying a broader time range.
        Indicates no articles found for that specific period.
      </description>
      <evidence>
        <file path="src/ignifer/adapters/gdelt.py" lines="191-202">
          Returns NO_DATA status with error message "No articles found. Try broader
          search terms or different keywords."
        </file>
        <file path="src/ignifer/output.py" lines="256-257">
          _format_no_data() includes "Expand temporal search range if available"
          in recommended actions.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC8" status="COMPLETE">
      <title>Cache Key Includes Time Range</title>
      <description>
        Cache key includes time_range to prevent stale results.
        Different time ranges don't share cached results.
      </description>
      <evidence>
        <file path="src/ignifer/adapters/gdelt.py" lines="77-79">
          timespan = params.time_range or "1week"
          key = cache_key(self.source_name, "articles", search_query=f"{params.query}:{timespan}")
        </file>
        <file path="tests/adapters/test_gdelt.py" lines="173-190">
          test_cache_key_includes_time_range() verifies different time ranges
          produce different URL parameters.
        </file>
      </evidence>
    </criterion>

    <criterion id="AC9" status="COMPLETE">
      <title>Tests Pass with Good Coverage</title>
      <description>
        All time range tests pass. Covers parsing, GDELT integration, and error cases.
      </description>
      <evidence>
        <file path="tests/test_timeparse.py">
          18 test methods covering:
          - test_parse_last_n_hours_valid
          - test_parse_last_n_days_valid
          - test_parse_last_n_weeks_valid
          - test_parse_last_n_months_valid
          - test_parse_this_week
          - test_parse_last_week
          - test_parse_iso_date_range
          - test_parse_iso_date_range_invalid_order
          - test_parse_iso_date_range_invalid_format
          - test_parse_invalid_format_returns_error
          - test_parse_case_insensitive
          - test_parse_n_unit_pattern
          - test_parse_whitespace_stripping
          - test_time_range_result_is_valid_property
        </file>
        <file path="tests/adapters/test_gdelt.py">
          4 time range tests:
          - test_query_with_time_range_uses_timespan
          - test_query_with_date_range_uses_datetime_params
          - test_query_default_time_range
          - test_cache_key_includes_time_range
        </file>
        <file path="tests/test_server.py">
          4 time range tests:
          - test_briefing_with_time_range
          - test_briefing_invalid_time_range_returns_error
          - test_briefing_default_time_range
          - test_briefing_rate_limited
        </file>
      </evidence>
    </criterion>
  </acceptance-criteria>

  <implementation-files>
    <file path="src/ignifer/timeparse.py" role="core" status="complete">
      <description>
        Time range parser module. Contains TimeRangeResult dataclass and
        parse_time_range() function. Handles natural language patterns
        ("last N hours/days/weeks/months", "this week", "last week") and
        ISO date ranges ("YYYY-MM-DD to YYYY-MM-DD").
      </description>
      <key-elements>
        <element name="TimeRangeResult" type="dataclass">
          Result with gdelt_timespan, start_datetime, end_datetime, error fields.
          is_valid property returns True if no error.
        </element>
        <element name="parse_time_range" type="function">
          Parses user input, returns TimeRangeResult with either gdelt_timespan
          for relative ranges or start_datetime/end_datetime for absolute ranges.
        </element>
        <element name="LAST_N_PATTERN" type="regex">
          Matches "last N hours/days/weeks/months" (case-insensitive).
        </element>
        <element name="N_UNIT_PATTERN" type="regex">
          Matches "N hours/days/weeks/months" without "last" prefix.
        </element>
        <element name="DATE_RANGE_PATTERN" type="regex">
          Matches "YYYY-MM-DD to YYYY-MM-DD" ISO date ranges.
        </element>
      </key-elements>
    </file>

    <file path="src/ignifer/server.py" role="mcp-tool" status="complete">
      <description>
        FastMCP server with briefing() tool. Added time_range parameter
        with validation and error handling.
      </description>
      <key-elements>
        <element name="briefing" type="mcp-tool" lines="188-306">
          Signature: briefing(topic: str, time_range: str | None = None) -> str
          Validates time_range with parse_time_range() before adapter call.
          Returns user-friendly error for invalid formats.
          Passes time_range to QueryParams and OutputFormatter.
        </element>
      </key-elements>
    </file>

    <file path="src/ignifer/adapters/gdelt.py" role="adapter" status="complete">
      <description>
        GDELT adapter with time range support in query() method.
        Cache key includes time_range for proper invalidation.
      </description>
      <key-elements>
        <element name="GDELTAdapter.query" type="method" lines="64-234">
          Parses time_range parameter. Adds timespan for relative ranges
          or startdatetime/enddatetime for absolute ranges to GDELT API call.
          Cache key format: "{query}:{time_range or '1week'}".
        </element>
      </key-elements>
    </file>

    <file path="src/ignifer/models.py" role="models" status="complete">
      <description>
        Pydantic models including QueryParams with time_range field.
      </description>
      <key-elements>
        <element name="QueryParams" type="model" lines="61-73">
          Added time_range: str | None = None field at line 73.
        </element>
      </key-elements>
    </file>

    <file path="src/ignifer/output.py" role="formatter" status="complete">
      <description>
        OutputFormatter with time_range display in briefing header.
      </description>
      <key-elements>
        <element name="OutputFormatter.format" type="method" lines="70-87">
          Accepts time_range parameter, passes to _format_success().
        </element>
        <element name="_format_success" type="method" lines="89-233">
          Displays "TIME RANGE: {value}" in header when provided (lines 112-113).
        </element>
        <element name="_format_no_data" type="method" lines="235-258">
          Includes "Expand temporal search range" suggestion (line 256).
        </element>
      </key-elements>
    </file>
  </implementation-files>

  <test-files>
    <file path="tests/test_timeparse.py" status="complete">
      <description>Unit tests for time range parser (18 test methods).</description>
      <coverage>
        <test name="test_parse_last_n_hours_valid">Hours parsing: "last 24 hours", "last 48 hours", "last 1 hour"</test>
        <test name="test_parse_last_n_days_valid">Days parsing: "last 7 days", "last 30 days", "last 1 day"</test>
        <test name="test_parse_last_n_weeks_valid">Weeks parsing: "last 2 weeks", "last 1 week"</test>
        <test name="test_parse_last_n_months_valid">Months parsing: "last 3 months", "last 1 month"</test>
        <test name="test_parse_this_week">"this week" maps to "7d"</test>
        <test name="test_parse_last_week">"last week" returns datetime range</test>
        <test name="test_parse_iso_date_range">ISO date range parsing</test>
        <test name="test_parse_iso_date_range_invalid_order">Start >= end validation</test>
        <test name="test_parse_iso_date_range_invalid_format">Invalid date format error</test>
        <test name="test_parse_invalid_format_returns_error">Unrecognized format error</test>
        <test name="test_parse_case_insensitive">Case insensitivity</test>
        <test name="test_parse_n_unit_pattern">"N unit" without "last" prefix</test>
        <test name="test_parse_whitespace_stripping">Whitespace handling</test>
        <test name="test_time_range_result_is_valid_property">is_valid property</test>
      </coverage>
    </file>

    <file path="tests/adapters/test_gdelt.py" status="complete">
      <description>GDELT adapter tests including time range (4 time range tests).</description>
      <coverage>
        <test name="test_query_with_time_range_uses_timespan">timespan=48h in URL</test>
        <test name="test_query_with_date_range_uses_datetime_params">startdatetime/enddatetime in URL</test>
        <test name="test_query_default_time_range">Default timespan=1week</test>
        <test name="test_cache_key_includes_time_range">Cache key isolation</test>
      </coverage>
    </file>

    <file path="tests/test_server.py" status="complete">
      <description>Server/briefing tool tests including time range (4 time range tests).</description>
      <coverage>
        <test name="test_briefing_with_time_range">TIME RANGE in output, QueryParams.time_range set</test>
        <test name="test_briefing_invalid_time_range_returns_error">Error message format</test>
        <test name="test_briefing_default_time_range">No TIME RANGE when not specified</test>
        <test name="test_briefing_rate_limited">Rate limited output format</test>
      </coverage>
    </file>
  </test-files>

  <test-coverage-summary>
    <parser-tests count="14">
      All natural language patterns, ISO date ranges, error cases, case insensitivity
    </parser-tests>
    <adapter-tests count="4">
      Timespan parameter, datetime parameters, default behavior, cache keys
    </adapter-tests>
    <integration-tests count="4">
      End-to-end briefing with time_range, error handling, default behavior
    </integration-tests>
    <total-time-range-tests>22</total-time-range-tests>
  </test-coverage-summary>

  <implementation-status>
    <overall>COMPLETE</overall>
    <notes>
      All 9 acceptance criteria are fully implemented and tested.
      The implementation follows the architecture patterns specified in the story:
      - snake_case for all fields (time_range)
      - timezone-aware datetime handling (timezone.utc)
      - stdlib logging only
      - Hybrid error handling (user-friendly messages, not exceptions)
      - Proper layer architecture (timeparse.py importable by adapters and server)

      Story can be marked as 'done' pending final verification with:
      pytest tests/ -v -k time_range
    </notes>
  </implementation-status>

  <dependencies>
    <requires>
      <story id="1-5">GDELT Adapter - implemented</story>
      <story id="1-6">briefing tool - implemented</story>
    </requires>
    <enables>
      <feature>Time-filtered economic queries (future enhancement)</feature>
    </enables>
  </dependencies>
</story-context>
