<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>2-2</story-id>
    <story-name>Economic Context Tool</story-name>
    <generated-at>2026-01-09</generated-at>
    <status>IMPLEMENTATION COMPLETE - Context generated for reference</status>
  </metadata>

  <story-summary>
    <user-story>
      As a geopolitical analyst, I want to get economic indicators for any country,
      so that I can assess economic factors affecting geopolitical situations.
    </user-story>

    <scope>
      Add an `economic_context` MCP tool to server.py that queries multiple economic
      indicators from WorldBankAdapter and returns a formatted summary including GDP,
      GDP per capita, inflation, unemployment, trade balance, and population.
    </scope>

    <dependencies>
      <dependency status="COMPLETED">Story 2.1: World Bank Adapter</dependency>
    </dependencies>

    <enables>
      <feature>Multi-source correlation in Epic 7</feature>
    </enables>
  </story-summary>

  <acceptance-criteria>
    <criterion id="AC1" name="economic_context Tool Registered">
      <description>Tool is decorated with @mcp.tool(), accepts country name or ISO code, has comprehensive docstring</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC2" name="WorldBankAdapter Integration">
      <description>Uses _get_worldbank() lazy initializer, calls WorldBankAdapter.query() with QueryParams</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC3" name="Output Formatting Works">
      <description>Includes GDP, GDP per capita, inflation, unemployment, trade balance, population with source attribution</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC4" name="Invalid Country Handling">
      <description>Returns user-friendly error message with spelling and ISO code suggestions</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC5" name="Country Alias Resolution Works">
      <description>USA, United States, US, America all resolve correctly; regional aggregates work</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC6" name="Error Handling Follows Contract">
      <description>Handles AdapterTimeoutError, AdapterError, and unexpected exceptions gracefully</description>
      <status>IMPLEMENTED</status>
    </criterion>

    <criterion id="AC7" name="Tests Pass with Good Coverage">
      <description>All economic_context tests pass for success, error, and edge cases</description>
      <status>IMPLEMENTED</status>
    </criterion>
  </acceptance-criteria>

  <key-files>
    <file role="primary-implementation" status="COMPLETE">
      <path>src/ignifer/server.py</path>
      <description>Contains the economic_context tool implementation (lines 373-529)</description>
    </file>

    <file role="adapter" status="COMPLETE">
      <path>src/ignifer/adapters/worldbank.py</path>
      <description>WorldBankAdapter for querying World Bank API - provides economic indicator data</description>
    </file>

    <file role="models">
      <path>src/ignifer/models.py</path>
      <description>Pydantic models: OSINTResult, QueryParams, ResultStatus, SourceAttribution</description>
    </file>

    <file role="adapter-base">
      <path>src/ignifer/adapters/base.py</path>
      <description>Error hierarchy: AdapterError, AdapterTimeoutError, AdapterParseError</description>
    </file>

    <file role="tests" status="COMPLETE">
      <path>tests/test_server_economic.py</path>
      <description>Comprehensive test suite for economic_context tool (11 test cases)</description>
    </file>
  </key-files>

  <code-patterns>
    <pattern name="Lazy Adapter Initialization">
      <description>Global adapter instances initialized on first use via getter functions</description>
      <code-example><![CDATA[
# Global instances (initialized on first use)
_worldbank: WorldBankAdapter | None = None

def _get_worldbank() -> WorldBankAdapter:
    global _worldbank
    if _worldbank is None:
        _worldbank = WorldBankAdapter(cache=_get_cache())
    return _worldbank
]]></code-example>
      <source-file>src/ignifer/server.py</source-file>
      <lines>49-53</lines>
    </pattern>

    <pattern name="MCP Tool Definition">
      <description>FastMCP tool decorator with comprehensive docstring for tool discovery</description>
      <code-example><![CDATA[
@mcp.tool()
async def economic_context(country: str) -> str:
    """Get economic indicators for any country.

    Returns key economic data including GDP, inflation, unemployment,
    and trade balance from World Bank official statistics.

    Args:
        country: Country name (e.g., "Germany", "Japan") or ISO code (e.g., "DEU", "JPN")

    Returns:
        Formatted economic summary with source attribution.
    """
]]></code-example>
      <source-file>src/ignifer/server.py</source-file>
      <lines>373-385</lines>
    </pattern>

    <pattern name="Multi-Indicator Query Loop">
      <description>Query multiple indicators sequentially and collect results</description>
      <code-example><![CDATA[
indicators = [
    ("GDP", "gdp"),
    ("GDP per Capita", "gdp per capita"),
    ("Inflation", "inflation"),
    ("Unemployment", "unemployment"),
    ("Trade Balance", "trade balance"),
    ("Population", "population"),
]

adapter = _get_worldbank()
all_results: dict[str, dict[str, Any]] = {}

for label, indicator_name in indicators:
    params = QueryParams(query=f"{indicator_name} {country}")
    result = await adapter.query(params)

    if result.status == ResultStatus.SUCCESS and result.results:
        sorted_results = sorted(
            result.results,
            key=lambda x: str(x.get("year", "")),
            reverse=True
        )
        if sorted_results:
            all_results[label] = sorted_results[0]
]]></code-example>
      <source-file>src/ignifer/server.py</source-file>
      <lines>388-415</lines>
    </pattern>

    <pattern name="Error Handling Cascade">
      <description>Layered error handling: specific exceptions first, generic last</description>
      <code-example><![CDATA[
try:
    # ... tool logic ...
except AdapterTimeoutError as e:
    logger.warning(f"Timeout getting economic context for {country}: {e}")
    return (
        f"## Request Timed Out\n\n"
        f"Economic data request for **{country}** timed out.\n\n"
        f"**Suggestions:**\n"
        f"- Try again in a moment\n"
        f"- Check your network connection"
    )

except AdapterError as e:
    logger.error(f"Adapter error for {country}: {e}")
    if "rate limit" in str(e).lower():
        return "## Service Temporarily Unavailable..."
    return f"## Unable to Retrieve Data..."

except Exception as e:
    logger.exception(f"Unexpected error for {country}: {e}")
    return "## Error\n\nAn unexpected error occurred..."
]]></code-example>
      <source-file>src/ignifer/server.py</source-file>
      <lines>493-529</lines>
    </pattern>

    <pattern name="TSUKUYOMI Output Formatting">
      <description>Consistent visual formatting with box drawing characters</description>
      <code-example><![CDATA[
output = "=" * 55 + "\n"
output += f"{'ECONOMIC CONTEXT':^55}\n"
output += "=" * 55 + "\n"
output += f"COUNTRY: {country_name}\n\n"
output += f"KEY INDICATORS ({year}):\n"
output += f"  GDP:              ${gdp_trillion:.2f} trillion\n"
# ... more indicators ...
output += "\n" + "-" * 55 + "\n"
output += "Source: World Bank Open Data\n"
output += f"Retrieved: {retrieved_at}\n"
output += "=" * 55 + "\n"
]]></code-example>
      <source-file>src/ignifer/server.py</source-file>
      <lines>434-488</lines>
    </pattern>
  </code-patterns>

  <test-patterns>
    <pattern name="Async Tool Call Helper">
      <description>Call the wrapped async tool function directly via .fn attribute</description>
      <code-example><![CDATA[
async def call_economic_context(country: str) -> str:
    """Call the economic_context tool function."""
    return await economic_context.fn(country)
]]></code-example>
      <source-file>tests/test_server_economic.py</source-file>
      <lines>16-18</lines>
    </pattern>

    <pattern name="Mock Adapter with patch">
      <description>Patch the getter function to inject mock adapter</description>
      <code-example><![CDATA[
@pytest.mark.asyncio
async def test_economic_context_success(mock_osint_result):
    with patch("ignifer.server._get_worldbank") as mock_get_wb:
        mock_adapter = AsyncMock()
        mock_adapter.query.side_effect = [
            mock_osint_result("GDP", 25462700000000),
            mock_osint_result("GDP per capita", 76330),
            # ... more indicators ...
        ]
        mock_get_wb.return_value = mock_adapter

        result = await call_economic_context("United States")

        assert mock_adapter.query.call_count == 6
        assert "ECONOMIC CONTEXT" in result
]]></code-example>
      <source-file>tests/test_server_economic.py</source-file>
      <lines>57-91</lines>
    </pattern>

    <pattern name="OSINTResult Fixture Factory">
      <description>Parameterized fixture for creating test results</description>
      <code-example><![CDATA[
@pytest.fixture
def mock_osint_result():
    """Create a mock OSINTResult for testing."""
    def _make_result(indicator: str, value: float | None = None, year: str = "2023"):
        retrieved_at = datetime.now(timezone.utc)
        if value is None:
            return OSINTResult(
                status=ResultStatus.NO_DATA,
                query=f"{indicator} United States",
                results=[],
                sources=[],
                retrieved_at=retrieved_at,
            )
        return OSINTResult(
            status=ResultStatus.SUCCESS,
            query=f"{indicator} United States",
            results=[{
                "indicator": indicator,
                "country": "United States",
                "year": year,
                "value": value,
            }],
            sources=[],
            retrieved_at=retrieved_at,
        )
    return _make_result
]]></code-example>
      <source-file>tests/test_server_economic.py</source-file>
      <lines>29-54</lines>
    </pattern>

    <pattern name="Error Scenario Testing">
      <description>Test specific exception handling paths</description>
      <code-example><![CDATA[
@pytest.mark.asyncio
async def test_economic_context_timeout():
    """Test economic context with timeout error."""
    with patch("ignifer.server._get_worldbank") as mock_get_wb:
        mock_adapter = AsyncMock()
        mock_adapter.query.side_effect = AdapterTimeoutError("worldbank", 15.0)
        mock_get_wb.return_value = mock_adapter

        result = await call_economic_context("Germany")

        assert "Request Timed Out" in result
        assert "Germany" in result
]]></code-example>
      <source-file>tests/test_server_economic.py</source-file>
      <lines>149-163</lines>
    </pattern>
  </test-patterns>

  <imports-required>
    <import-group name="Standard Library">
      <import>import logging</import>
      <import>from datetime import datetime, timezone</import>
      <import>from typing import Any</import>
    </import-group>

    <import-group name="Adapters">
      <import>from ignifer.adapters import AdapterError, AdapterTimeoutError, WorldBankAdapter</import>
    </import-group>

    <import-group name="Internal">
      <import>from ignifer.models import QueryParams, ResultStatus</import>
      <import>from ignifer.cache import CacheManager</import>
    </import-group>
  </imports-required>

  <worldbank-adapter-reference>
    <indicators>
      <indicator key="gdp" code="NY.GDP.MKTP.CD">GDP (current US$)</indicator>
      <indicator key="gdp per capita" code="NY.GDP.PCAP.CD">GDP per capita (current US$)</indicator>
      <indicator key="inflation" code="FP.CPI.TOTL.ZG">Inflation, consumer prices (annual %)</indicator>
      <indicator key="population" code="SP.POP.TOTL">Population, total</indicator>
      <indicator key="trade" code="NE.RSB.GNFS.CD">External balance on goods and services</indicator>
      <indicator key="unemployment" code="SL.UEM.TOTL.ZS">Unemployment, total (% of labor force)</indicator>
    </indicators>

    <country-aliases>
      <alias input="usa">USA</alias>
      <alias input="us">USA</alias>
      <alias input="united states">USA</alias>
      <alias input="america">USA</alias>
      <alias input="china">CHN</alias>
      <alias input="germany">DEU</alias>
      <alias input="japan">JPN</alias>
      <alias input="uk">GBR</alias>
      <alias input="france">FRA</alias>
      <alias input="india">IND</alias>
      <alias input="brazil">BRA</alias>
      <alias input="russia">RUS</alias>
      <alias input="eu">EUU</alias>
      <alias input="european union">EUU</alias>
      <alias input="sub-saharan africa">SSF</alias>
    </country-aliases>

    <cache-ttl>24 hours (settings.ttl_worldbank)</cache-ttl>
    <quality-tier>HIGH (official government data)</quality-tier>
  </worldbank-adapter-reference>

  <architecture-compliance>
    <rule name="Adapter-owned httpx clients">WorldBankAdapter manages its own httpx.AsyncClient</rule>
    <rule name="Layer rule">server.py imports from adapters, NOT vice versa</rule>
    <rule name="stdlib logging">Uses logging.getLogger(__name__)</rule>
    <rule name="ISO 8601 + timezone">All datetime uses datetime.now(timezone.utc)</rule>
    <rule name="snake_case">All JSON fields use snake_case</rule>
    <rule name="Hybrid error handling">Exceptions for unexpected (timeout), Result type for expected (no_data)</rule>
  </architecture-compliance>

  <implementation-status>
    <status>COMPLETE</status>
    <notes>
      The economic_context tool has been fully implemented in server.py (lines 373-529).
      Comprehensive tests exist in tests/test_server_economic.py with 11 test cases covering:
      - Success scenarios with full and partial data
      - Country not found handling
      - Timeout error handling
      - Rate limit error handling
      - Generic adapter error handling
      - Unexpected exception handling
      - Different year scenarios
      - Positive/negative trade balance formatting
      - Country alias resolution
    </notes>
  </implementation-status>
</story-context>
